---
import BaseLayout from './BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import Sidebar from '@/components/layout/Sidebar.astro';
import TableOfContents from '@/components/layout/TableOfContents.astro';
import TabNavigation from '@/components/layout/TabNavigation.tsx';
import RunnableCodeBlock from '@/components/interactive/RunnableCodeBlock';
import type { CourseMetadata, Chapter } from '@/types/course';
import type { MarkdownHeading } from 'astro';
import type { TabContent } from '@/lib/utils/tabParser';

interface Props {
  frontmatter: CourseMetadata;
  chapters: Chapter[];
  prevLesson?: CourseMetadata | null;
  nextLesson?: CourseMetadata | null;
  headings: MarkdownHeading[];
  tabs?: TabContent[] | null;
}

const { frontmatter, chapters, prevLesson, nextLesson, headings, tabs } = Astro.props;
const base = import.meta.env.BASE_URL;
const hasTabs = tabs && tabs.length > 0;
---

<BaseLayout title={frontmatter.title} description={frontmatter.description}>
  <div class="min-h-screen flex flex-col">
    <Header />

    <div class="flex-1 flex">
      <!-- ä¾§è¾¹æ  -->
      <Sidebar chapters={chapters} currentSlug={frontmatter.slug} />

      <!-- ä¸»å†…å®¹åŒº -->
      <main class="flex-1">
        <div class="flex max-w-[1600px] mx-auto">
          <!-- æ–‡ç« å†…å®¹ -->
          <div class="flex-1 min-w-0">
            <div class="container mx-auto px-4 py-8 max-w-4xl">
          <!-- é¢åŒ…å±‘å¯¼èˆª -->
          <nav class="text-sm text-gray-600 mb-6">
            <a href={base} class="hover:text-primary">é¦–é¡µ</a>
            <span class="mx-2">/</span>
            <span>{frontmatter.chapterTitle}</span>
            <span class="mx-2">/</span>
            <span class="text-gray-900 font-medium">{frontmatter.title}</span>
          </nav>

          <!-- è¯¾ç¨‹å…ƒä¿¡æ¯ -->
          <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">
              {frontmatter.title}
            </h1>
            <p class="text-lg text-gray-600 mb-4">
              {frontmatter.description}
            </p>

            <div class="flex flex-wrap gap-3 text-sm">
              {frontmatter.duration && (
                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full">
                  â±ï¸ {frontmatter.duration} åˆ†é’Ÿ
                </span>
              )}
              {frontmatter.difficulty && (
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full">
                  ğŸ“Š {frontmatter.difficulty === 'beginner' ? 'åˆçº§' : frontmatter.difficulty === 'intermediate' ? 'ä¸­çº§' : 'é«˜çº§'}
                </span>
              )}
              {frontmatter.tags && frontmatter.tags.map((tag) => (
                <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          <!-- Tabå¯¼èˆªï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ -->
          {hasTabs && (
            <TabNavigation
              tabs={tabs!.map(t => ({ id: t.id, title: t.title }))}
              currentSlug={frontmatter.slug}
              onTabChange={(tabId) => {
                // è§¦å‘tabåˆ‡æ¢äº‹ä»¶
                const event = new CustomEvent('tab-change', {
                  detail: { tabId }
                });
                window.dispatchEvent(event);
              }}
              client:load
            />
          )}

          <!-- è¯¾ç¨‹å†…å®¹ -->
          {hasTabs ? (
            <!-- Tabæ¨¡å¼ï¼šä½¿ç”¨æ¸²æŸ“åçš„å†…å®¹ï¼Œé€šè¿‡JSæ§åˆ¶æ˜¾ç¤º -->
            <article class="prose prose-lg max-w-none mb-12" id="tab-article">
              <slot />
            </article>
          ) : (
            <!-- æ™®é€šæ¨¡å¼ï¼šç›´æ¥æ¸²æŸ“ -->
            <article class="prose prose-lg max-w-none mb-12">
              <slot />
            </article>
          )}

          <!-- ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µå¯¼èˆª -->
          <nav class="pt-8 mt-12">
            <div class="flex justify-between items-center" style="min-height: 48px;">
              <div class="flex-1" style="min-height: 48px;">
                <a
                  id="prev-nav-link"
                  href={prevLesson?.url || '#'}
                  data-default-url={prevLesson?.url || ''}
                  data-default-title={prevLesson?.title || ''}
                  data-has-prev-lesson={prevLesson ? 'true' : 'false'}
                  class="inline-flex items-center text-primary hover:text-primary-dark transition-colors group"
                  style={!prevLesson ? 'display: none;' : ''}
                >
                  <svg class="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                  </svg>
                  <div class="text-left">
                    <div id="prev-nav-label" class="text-xs text-gray-500">ä¸Šä¸€è¯¾</div>
                    <div id="prev-nav-title" class="font-medium">{prevLesson?.title || ''}</div>
                  </div>
                </a>
              </div>

              <div class="flex-1 text-right" style="min-height: 48px;">
                <a
                  id="next-nav-link"
                  href={nextLesson?.url || '#'}
                  data-default-url={nextLesson?.url || ''}
                  data-default-title={nextLesson?.title || ''}
                  data-has-next-lesson={nextLesson ? 'true' : 'false'}
                  class="inline-flex items-center text-primary hover:text-primary-dark transition-colors group"
                  style={!nextLesson ? 'display: none;' : ''}
                >
                  <div class="text-right">
                    <div id="next-nav-label" class="text-xs text-gray-500">ä¸‹ä¸€è¯¾</div>
                    <div id="next-nav-title" class="font-medium">{nextLesson?.title || ''}</div>
                  </div>
                  <svg class="w-5 h-5 ml-2 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>
              </div>
            </div>
          </nav>
            </div>
          </div>

          <!-- å³ä¾§ç›®å½• -->
          <aside class="hidden xl:block w-64 pl-8 py-8 sticky top-16 h-[calc(100vh-4rem)] overflow-y-auto">
            <TableOfContents headings={headings} />
          </aside>
        </div>
      </main>
    </div>
  </div>
</BaseLayout>

<style>
  /* ä¸º Markdown å†…å®¹æ·»åŠ æ ·å¼ */
  article :global(h2) {
    @apply text-3xl font-bold mt-12 mb-4 pb-2 border-b border-gray-200;
  }

  article :global(h3) {
    @apply text-2xl font-bold mt-8 mb-3;
  }

  article :global(p) {
    @apply mb-4 leading-relaxed text-gray-700;
  }

  article :global(ul),
  article :global(ol) {
    @apply mb-4 pl-6;
  }

  article :global(li) {
    @apply mb-2;
  }

  article :global(code) {
    @apply bg-gray-100 px-2 py-1 rounded text-sm font-mono text-gray-800;
  }

  article :global(pre) {
    @apply p-4 rounded-lg overflow-x-auto my-6 bg-gray-900;
  }

  article :global(pre code) {
    @apply bg-transparent p-0 text-gray-100;
  }

  article :global(blockquote) {
    @apply border-l-4 border-primary bg-blue-50 pl-4 py-2 my-4 italic;
  }

  article :global(a) {
    @apply text-primary hover:text-primary-dark underline;
  }

  article :global(strong) {
    @apply font-bold text-gray-900;
  }

  article :global(img) {
    @apply rounded-lg shadow-md my-6;
  }
</style>

<script define:vars={{ slug: frontmatter.slug }}>
  // è‡ªåŠ¨æ ‡è®°è¯¾ç¨‹å®Œæˆ
  function markLessonAsCompleted() {
    try {
      const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');

      if (!completedLessons.includes(slug)) {
        completedLessons.push(slug);
        localStorage.setItem('completedLessons', JSON.stringify(completedLessons));

        // è§¦å‘ storage äº‹ä»¶ä»¥æ›´æ–°å…¶ä»–é¡µé¢
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'completedLessons',
          newValue: JSON.stringify(completedLessons),
          oldValue: JSON.stringify(completedLessons.slice(0, -1))
        }));

        console.log('âœ… è¯¾ç¨‹å·²æ ‡è®°ä¸ºå®Œæˆ:', slug);
      }
    } catch (error) {
      console.error('Failed to mark lesson as completed:', error);
    }
  }

  // æ£€æµ‹ç”¨æˆ·æ˜¯å¦æ»šåŠ¨åˆ°é¡µé¢åº•éƒ¨
  function checkScrollCompletion() {
    const scrolled = window.scrollY + window.innerHeight;
    const height = document.documentElement.scrollHeight;

    // å½“æ»šåŠ¨åˆ°é¡µé¢ 80% æ—¶æ ‡è®°ä¸ºå®Œæˆ
    if (scrolled >= height * 0.8) {
      markLessonAsCompleted();
      // ç§»é™¤ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ ‡è®°
      window.removeEventListener('scroll', checkScrollCompletion);
    }
  }

  // é¡µé¢åŠ è½½åæ·»åŠ æ»šåŠ¨ç›‘å¬
  window.addEventListener('scroll', checkScrollCompletion);

  // å¦‚æœé¡µé¢å¾ˆçŸ­ï¼Œç«‹å³æ£€æŸ¥
  setTimeout(checkScrollCompletion, 1000);
</script>

<!-- Tabå†…å®¹æ§åˆ¶è„šæœ¬ -->
<script define:vars={{ hasTabs, tabs, slug: frontmatter.slug }}>
  if (hasTabs && tabs) {
    // ä¸ºæ¯ä¸ªh1æ ‡é¢˜æ·»åŠ tabæ ‡è¯†
    const article = document.getElementById('tab-article');
    if (article) {
      const h1Elements = article.querySelectorAll('h1');

      // è·å–ä¿å­˜çš„å½“å‰ tab ç´¢å¼•
      let savedTabIndex = 0;
      try {
        const key = `tab-progress-${slug}`;
        const saved = localStorage.getItem(key);
        if (saved) {
          const progress = JSON.parse(saved);
          savedTabIndex = progress.currentTab || 0;
        }
      } catch (e) {
        console.error('Failed to load tab progress:', e);
      }

      // ä¸ºæ¯ä¸ªh1åŠå…¶åç»­å†…å®¹æ·»åŠ tabæ ‡è¯†
      h1Elements.forEach((h1, index) => {
        const tabId = `tab-${index}`;
        h1.setAttribute('data-tab-section', tabId);

        // éšè—æ‰€æœ‰h1æ ‡é¢˜ï¼ˆå› ä¸ºå·²ç»åœ¨tabå¯¼èˆªæ˜¾ç¤ºäº†ï¼‰
        h1.style.display = 'none';

        // æ‰¾åˆ°å½“å‰h1å’Œä¸‹ä¸€ä¸ªh1ä¹‹é—´çš„æ‰€æœ‰å…ƒç´ 
        let currentElement = h1.nextElementSibling;
        while (currentElement && currentElement.tagName !== 'H1') {
          currentElement.setAttribute('data-tab-section', tabId);
          currentElement = currentElement.nextElementSibling;
        }

        // æ ¹æ®ä¿å­˜çš„ tab ç´¢å¼•æ˜¾ç¤º/éšè—å†…å®¹
        if (index !== savedTabIndex) {
          let hideElement = h1.nextElementSibling;
          while (hideElement && hideElement.tagName !== 'H1') {
            hideElement.style.display = 'none';
            hideElement = hideElement.nextElementSibling;
          }
        }
      });

      // ç›‘å¬tabåˆ‡æ¢äº‹ä»¶
      window.addEventListener('tab-change', (e) => {
        const targetTabId = e.detail.tabId;

        // éšè—æ‰€æœ‰tabå†…å®¹
        h1Elements.forEach((h1) => {
          const tabId = h1.getAttribute('data-tab-section');
          h1.style.display = 'none';
          let hideElement = h1.nextElementSibling;
          while (hideElement && hideElement.tagName !== 'H1') {
            hideElement.style.display = 'none';
            hideElement = hideElement.nextElementSibling;
          }
        });

        // æ˜¾ç¤ºç›®æ ‡tabå†…å®¹
        const targetH1 = article.querySelector(`[data-tab-section="${targetTabId}"]`);
        if (targetH1 && targetH1.tagName === 'H1') {
          // H1 æ ‡é¢˜ä¿æŒéšè—ï¼ˆå·²ç»æ˜¾ç¤ºåœ¨tabå¯¼èˆªä¸­ï¼‰
          targetH1.style.display = 'none';
          // åªæ˜¾ç¤º H1 åé¢çš„å†…å®¹
          let showElement = targetH1.nextElementSibling;
          while (showElement && showElement.tagName !== 'H1') {
            showElement.style.display = 'block';
            showElement = showElement.nextElementSibling;
          }
        }
      });
    }
  }
</script>

<!-- Tabå¯¼èˆªæ§åˆ¶è„šæœ¬ -->
<script define:vars={{ hasTabs, tabs, slug: frontmatter.slug }}>
  if (hasTabs && tabs && tabs.length > 0) {
    // è·å–å½“å‰ tab ç´¢å¼•
    function getCurrentTabIndex() {
      const key = `tab-progress-${slug}`;
      const saved = localStorage.getItem(key);
      if (saved) {
        try {
          const progress = JSON.parse(saved);
          return progress.currentTab || 0;
        } catch (e) {
          return 0;
        }
      }
      return 0;
    }

    // åˆ‡æ¢åˆ°æŒ‡å®šçš„ tab
    function switchToTab(tabIndex) {
      if (tabIndex >= 0 && tabIndex < tabs.length) {
        const tabId = tabs[tabIndex].id;
        const event = new CustomEvent('tab-change', {
          detail: { tabId }
        });
        window.dispatchEvent(event);

        // ä¿å­˜ tab è¿›åº¦
        const key = `tab-progress-${slug}`;
        localStorage.setItem(key, JSON.stringify({
          currentTab: tabIndex,
          lastUpdated: Date.now(),
        }));

        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // æ›´æ–°å¯¼èˆªæŒ‰é’®
    function updateNavigation() {
      const currentTabIndex = getCurrentTabIndex();
      const prevLink = document.getElementById('prev-nav-link');
      const nextLink = document.getElementById('next-nav-link');
      const prevTitle = document.getElementById('prev-nav-title');
      const nextTitle = document.getElementById('next-nav-title');
      const prevLabel = document.getElementById('prev-nav-label');
      const nextLabel = document.getElementById('next-nav-label');

      // æ›´æ–°"ä¸Šä¸€è¯¾"æŒ‰é’®
      if (prevLink && prevTitle) {
        if (currentTabIndex > 0) {
          // ä¸æ˜¯ç¬¬ä¸€ä¸ª tabï¼Œé“¾æ¥åˆ°ä¸Šä¸€ä¸ª tab
          const prevTab = tabs[currentTabIndex - 1];
          prevLink.href = 'javascript:void(0)';
          prevLink.style.display = 'inline-flex'; // ç¡®ä¿æ˜¾ç¤º
          prevLink.onclick = (e) => {
            e.preventDefault();
            switchToTab(currentTabIndex - 1);
            return false;
          };
          prevTitle.textContent = prevTab.title;
          if (prevLabel) {
            prevLabel.textContent = 'ä¸Šä¸€èŠ‚'; // Tab å¯¼èˆªç”¨"ä¸Šä¸€èŠ‚"
          }
        } else {
          // æ˜¯ç¬¬ä¸€ä¸ª tab
          const hasPrevLesson = prevLink.getAttribute('data-has-prev-lesson') === 'true';
          if (hasPrevLesson) {
            // æœ‰ä¸Šä¸€è¯¾ï¼Œæ¢å¤é»˜è®¤é“¾æ¥
            const defaultUrl = prevLink.getAttribute('data-default-url');
            const defaultTitle = prevLink.getAttribute('data-default-title');
            prevLink.href = defaultUrl;
            prevLink.style.display = 'inline-flex'; // ç¡®ä¿æ˜¾ç¤º
            prevLink.onclick = null;
            prevTitle.textContent = defaultTitle;
            if (prevLabel) {
              prevLabel.textContent = 'ä¸Šä¸€è¯¾'; // è·¨è¯¾ç¨‹å¯¼èˆªç”¨"ä¸Šä¸€è¯¾"
            }
          } else {
            // æ²¡æœ‰ä¸Šä¸€è¯¾ï¼Œéšè—æŒ‰é’®
            prevLink.style.display = 'none';
          }
        }
      }

      // æ›´æ–°"ä¸‹ä¸€è¯¾"æŒ‰é’®
      if (nextLink && nextTitle) {
        if (currentTabIndex < tabs.length - 1) {
          // ä¸æ˜¯æœ€åä¸€ä¸ª tabï¼Œé“¾æ¥åˆ°ä¸‹ä¸€ä¸ª tab
          const nextTab = tabs[currentTabIndex + 1];
          nextLink.href = 'javascript:void(0)';
          nextLink.style.display = 'inline-flex'; // ç¡®ä¿æ˜¾ç¤º
          nextLink.onclick = (e) => {
            e.preventDefault();
            switchToTab(currentTabIndex + 1);
            return false;
          };
          nextTitle.textContent = nextTab.title;
          if (nextLabel) {
            nextLabel.textContent = 'ä¸‹ä¸€èŠ‚'; // Tab å¯¼èˆªç”¨"ä¸‹ä¸€èŠ‚"
          }
        } else {
          // æ˜¯æœ€åä¸€ä¸ª tab
          const hasNextLesson = nextLink.getAttribute('data-has-next-lesson') === 'true';
          if (hasNextLesson) {
            // æœ‰ä¸‹ä¸€è¯¾ï¼Œæ¢å¤é»˜è®¤é“¾æ¥
            const defaultUrl = nextLink.getAttribute('data-default-url');
            const defaultTitle = nextLink.getAttribute('data-default-title');
            nextLink.href = defaultUrl;
            nextLink.style.display = 'inline-flex'; // ç¡®ä¿æ˜¾ç¤º
            nextLink.onclick = null;
            nextTitle.textContent = defaultTitle;
            if (nextLabel) {
              nextLabel.textContent = 'ä¸‹ä¸€è¯¾'; // è·¨è¯¾ç¨‹å¯¼èˆªç”¨"ä¸‹ä¸€è¯¾"
            }
          } else {
            // æ²¡æœ‰ä¸‹ä¸€è¯¾ï¼Œéšè—æŒ‰é’®
            nextLink.style.display = 'none';
          }
        }
      }
    }

    // åˆå§‹åŒ–å¯¼èˆª
    updateNavigation();

    // ç›‘å¬ tab åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°å¯¼èˆª
    window.addEventListener('tab-change', () => {
      // å»¶è¿Ÿæ›´æ–°ï¼Œç­‰å¾… localStorage ä¿å­˜å®Œæˆ
      setTimeout(updateNavigation, 50);
    });
  }

