---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// åªæ˜¾ç¤º h2 å’Œ h3 æ ‡é¢˜
const filteredHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
---

{filteredHeadings.length > 0 && (
  <nav class="max-h-full overflow-y-auto">
    <h3 class="text-sm font-bold text-gray-900 mb-4 px-4">ğŸ“‘ ç›®å½•</h3>
    <ul class="space-y-1 text-sm">
      {filteredHeadings.map((heading) => (
        <li
          class={heading.depth === 2 ? 'pl-4' : 'pl-8'}
          data-heading-slug={heading.slug}
        >
          <a
            href={`#${heading.slug}`}
            class="block py-1.5 text-gray-600 hover:text-primary transition-colors rounded hover:bg-gray-50 px-2"
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  /* æ»šåŠ¨æ¡æ ·å¼ */
  nav::-webkit-scrollbar {
    width: 4px;
  }

  nav::-webkit-scrollbar-track {
    background: transparent;
  }

  nav::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 2px;
  }

  nav::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>

<script>
  // å¹³æ»‘æ»šåŠ¨ï¼Œå¸¦åç§»é‡ï¼ˆè¡¥å¿å›ºå®šçš„ headerï¼‰
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const targetId = this.getAttribute('href');
      const target = document.querySelector(targetId);
      if (target) {
        // header é«˜åº¦æ˜¯ 64px (h-16)ï¼Œå†åŠ  20px çš„é¢å¤–é—´è·
        const headerOffset = 84;
        const elementPosition = target.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        window.scrollTo({
          top: offsetPosition,
          behavior: 'smooth'
        });
      }
    });
  });

  // æ»šåŠ¨æ—¶é«˜äº®å½“å‰æ ‡é¢˜
  function updateActiveHeading() {
    const headings = document.querySelectorAll('article h2[id], article h3[id]');
    const tocLinks = document.querySelectorAll('[data-heading-slug] a');

    let currentHeading = '';

    headings.forEach((heading) => {
      const rect = heading.getBoundingClientRect();
      // è€ƒè™‘ header çš„é«˜åº¦ï¼Œå½“æ ‡é¢˜åœ¨è§†å£ä¸Šæ–¹ 100px æ—¶å°±è®¤ä¸ºæ˜¯å½“å‰æ ‡é¢˜
      if (rect.top <= 100) {
        currentHeading = heading.id;
      }
    });

    tocLinks.forEach((link) => {
      const href = link.getAttribute('href')?.substring(1);
      if (href === currentHeading) {
        link.classList.add('text-primary', 'font-medium', 'bg-blue-50');
        link.classList.remove('text-gray-600');
      } else {
        link.classList.remove('text-primary', 'font-medium', 'bg-blue-50');
        link.classList.add('text-gray-600');
      }
    });
  }

  // ç›‘å¬æ»šåŠ¨
  window.addEventListener('scroll', updateActiveHeading);
  // åˆå§‹åŒ–
  updateActiveHeading();
</script>
