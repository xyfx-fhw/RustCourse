---
import type { MarkdownHeading } from 'astro';

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// æ˜¾ç¤ºæ‰€æœ‰çº§åˆ«çš„æ ‡é¢˜ï¼šh1ï¼ˆtabæ ‡é¢˜ï¼‰ã€h2ã€h3
const filteredHeadings = headings.filter(h => h.depth === 1 || h.depth === 2 || h.depth === 3);
---

{filteredHeadings.length > 0 && (
  <nav class="max-h-full overflow-y-auto">
    <h3 class="text-sm font-bold text-gray-900 mb-4 px-4">ğŸ“‘ ç›®å½•</h3>
    <ul class="space-y-1 text-sm">
      {filteredHeadings.map((heading) => (
        <li
          class={
            heading.depth === 1 ? 'pl-2' :
            heading.depth === 2 ? 'pl-6' :
            'pl-10'
          }
          data-heading-slug={heading.slug}
        >
          <a
            href={`#${heading.slug}`}
            class={`block py-1.5 transition-colors rounded hover:bg-gray-50 px-2 ${
              heading.depth === 1 ? 'text-gray-800 font-semibold hover:text-primary' : 'text-gray-600 hover:text-primary'
            }`}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  /* æ»šåŠ¨æ¡æ ·å¼ */
  nav::-webkit-scrollbar {
    width: 4px;
  }

  nav::-webkit-scrollbar-track {
    background: transparent;
  }

  nav::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 2px;
  }

  nav::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>

<script>
  // å¹³æ»‘æ»šåŠ¨ï¼Œå¸¦åç§»é‡ï¼ˆè¡¥å¿å›ºå®šçš„ headerï¼‰
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const targetId = this.getAttribute('href');
      const target = document.querySelector(targetId);
      if (target) {
        // å¦‚æœç›®æ ‡å…ƒç´ åœ¨éšè—çš„tabä¸­ï¼Œå…ˆåˆ‡æ¢åˆ°å¯¹åº”çš„tab
        const tabSection = target.getAttribute('data-tab-section');
        if (tabSection) {
          // è§¦å‘tabåˆ‡æ¢äº‹ä»¶
          const event = new CustomEvent('tab-change', {
            detail: { tabId: tabSection }
          });
          window.dispatchEvent(event);

          // ç­‰å¾…tabåˆ‡æ¢å®Œæˆåå†æ»šåŠ¨
          setTimeout(() => {
            const headerOffset = 84;
            const elementPosition = target.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });
          }, 100);
        } else {
          // æ™®é€šæ»šåŠ¨ï¼ˆétabæ¨¡å¼ï¼‰
          const headerOffset = 84;
          const elementPosition = target.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });
        }
      }
    });
  });

  // æ»šåŠ¨æ—¶é«˜äº®å½“å‰æ ‡é¢˜
  function updateActiveHeading() {
    // åªæ£€æŸ¥å¯è§çš„æ ‡é¢˜ï¼ˆå½“å‰tabä¸­çš„ï¼‰
    const headings = document.querySelectorAll('article h2[id], article h3[id]');
    const tocLinks = document.querySelectorAll('[data-heading-slug] a');

    let currentHeading = '';

    headings.forEach((heading) => {
      // åªè€ƒè™‘å¯è§çš„æ ‡é¢˜
      if (heading.offsetParent !== null) {
        const rect = heading.getBoundingClientRect();
        // è€ƒè™‘ header çš„é«˜åº¦ï¼Œå½“æ ‡é¢˜åœ¨è§†å£ä¸Šæ–¹ 100px æ—¶å°±è®¤ä¸ºæ˜¯å½“å‰æ ‡é¢˜
        if (rect.top <= 100) {
          currentHeading = heading.id;
        }
      }
    });

    tocLinks.forEach((link) => {
      const href = link.getAttribute('href')?.substring(1);
      if (href === currentHeading) {
        link.classList.add('text-primary', 'font-medium', 'bg-blue-50');
        link.classList.remove('text-gray-600');
      } else {
        link.classList.remove('text-primary', 'font-medium', 'bg-blue-50');
        link.classList.add('text-gray-600');
      }
    });
  }

  // ç›‘å¬æ»šåŠ¨
  window.addEventListener('scroll', updateActiveHeading);

  // ç›‘å¬ tab åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°é«˜äº®
  window.addEventListener('tab-change', () => {
    setTimeout(updateActiveHeading, 100);
  });

  // åˆå§‹åŒ–
  updateActiveHeading();
</script>
