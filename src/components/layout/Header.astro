---
import { getCollection } from 'astro:content';

// é¡¶éƒ¨å¯¼èˆªæ 
const base = import.meta.env.BASE_URL;

// è·å–æ€»è¯¾ç¨‹æ•°
const allCourses = await getCollection('courses');
const totalLessons = allCourses.length;
---

<header class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      <!-- Logo å’Œæ ‡é¢˜ -->
      <div class="flex items-center space-x-4">
        <a href={base} class="flex items-center space-x-2 hover:opacity-80 transition-opacity">
          <span class="text-3xl">ğŸ¦€</span>
          <span class="text-xl font-bold text-gray-900">Rust å­¦ä¹ è¯¾ç¨‹</span>
        </a>
      </div>

      <!-- å¯¼èˆªé“¾æ¥ -->
      <nav class="hidden md:flex items-center space-x-6">
        <a
          href={base}
          class="text-gray-700 hover:text-primary transition-colors font-medium"
        >
          é¦–é¡µ
        </a>
        <a
          href={`${base}/courses/01-rust-basics/01-installation`}
          class="text-gray-700 hover:text-primary transition-colors font-medium"
        >
          å¼€å§‹å­¦ä¹ 
        </a>
        <a
          href={`${base}/dashboard`}
          class="text-gray-700 hover:text-primary transition-colors font-medium"
        >
          å­¦ä¹ è¿›åº¦
        </a>

        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆå¾®è½¯é£æ ¼ï¼‰ -->
        <div class="flex items-center space-x-2 px-3 py-1.5 bg-blue-50 rounded-full" id="header-progress">
          <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-sm font-medium text-primary" id="header-progress-text">0%</span>
        </div>
      </nav>

      <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
      <button
        id="mobile-menu-button"
        class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
        aria-label="æ‰“å¼€èœå•"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯èœå• -->
  <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200">
    <nav class="container mx-auto px-4 py-4 space-y-2">
      <a
        href={base}
        class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
      >
        é¦–é¡µ
      </a>
      <a
        href={`${base}/courses/01-rust-basics/01-installation`}
        class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
      >
        å¼€å§‹å­¦ä¹ 
      </a>
      <a
        href={`${base}/dashboard`}
        class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
      >
        å­¦ä¹ è¿›åº¦
      </a>
    </nav>
  </div>
</header>

<script define:vars={{ totalLessons }}>
  // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
  const menuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  menuButton?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  // æ›´æ–° header è¿›åº¦æŒ‡ç¤ºå™¨
  function updateHeaderProgress() {
    try {
      const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');

      const percentage = totalLessons > 0 ? Math.round((completedLessons.length / totalLessons) * 100) : 0;

      const progressText = document.getElementById('header-progress-text');
      const progressContainer = document.getElementById('header-progress');

      if (progressText) {
        progressText.textContent = `${percentage}%`;
      }

      // æ ¹æ®è¿›åº¦æ”¹å˜é¢œè‰²
      if (progressContainer) {
        if (percentage === 100) {
          progressContainer.className = 'flex items-center space-x-2 px-3 py-1.5 bg-green-50 rounded-full';
          const icon = progressContainer.querySelector('svg');
          if (icon) icon.className = 'w-4 h-4 text-green-600';
          if (progressText) progressText.className = 'text-sm font-medium text-green-600';
        } else if (percentage >= 50) {
          progressContainer.className = 'flex items-center space-x-2 px-3 py-1.5 bg-yellow-50 rounded-full';
          const icon = progressContainer.querySelector('svg');
          if (icon) icon.className = 'w-4 h-4 text-yellow-600';
          if (progressText) progressText.className = 'text-sm font-medium text-yellow-600';
        }
      }
    } catch (error) {
      console.error('Failed to update header progress:', error);
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ›´æ–°è¿›åº¦
  updateHeaderProgress();

  // ç›‘å¬ storage å˜åŒ–ï¼ˆè·¨æ ‡ç­¾é¡µåŒæ­¥ï¼‰
  window.addEventListener('storage', (e) => {
    if (e.key === 'completedLessons') {
      updateHeaderProgress();
    }
  });
</script>
