---
import { getCollection } from 'astro:content';
import { parseTabContent } from '@/lib/utils/tabParser';
import { groupByChapter, parseChapterName } from '@/lib/utils/courseLoader';
import type { CourseMetadata } from '@/types/course';

// é¡¶éƒ¨å¯¼èˆªæ 
const base = import.meta.env.BASE_URL;

// è·å–æ‰€æœ‰è¯¾ç¨‹å¹¶è®¡ç®—tabä¿¡æ¯
const allCourses = await getCollection('courses');

// è®¡ç®—ç¬¬ä¸€ä¸ªè¯¾ç¨‹çš„URL
const allCoursesMetadata: CourseMetadata[] = allCourses.map((c) => {
  const slugParts = c.slug.split('/');
  const ch = slugParts[0];
  const ls = slugParts[1];
  const ss = slugParts.length === 3 ? slugParts[2] : undefined;
  const chInfo = parseChapterName(ch);

  return {
    ...c.data,
    slug: c.slug,
    chapter: ch,
    chapterTitle: chInfo.title,
    lesson: ls,
    subsection: ss,
    url: `${base}/courses/${c.slug}`,
  };
});

const chapters = groupByChapter(allCoursesMetadata);

// è·å–ç¬¬ä¸€ä¸ªè¯¾ç¨‹/å°èŠ‚çš„URL
let firstLessonUrl = `${base}/courses/01-rust-basics/01-installation`;
if (chapters.length > 0 && chapters[0].lessons.length > 0) {
  const firstLesson = chapters[0].lessons[0];
  if (firstLesson.subsections.length > 0) {
    firstLessonUrl = firstLesson.subsections[0].metadata.url;
  } else if (firstLesson.metadata) {
    firstLessonUrl = firstLesson.metadata.url;
  }
}

// è®¡ç®—tabä¿¡æ¯ï¼šå“ªäº›è¯¾ç¨‹æœ‰tabï¼Œæ¯ä¸ªtabçš„ID
const courseTabInfo: Record<string, { hasTabs: boolean; tabIds: string[] }> = {};
for (const course of allCourses) {
  const tabs = parseTabContent(course.body);
  courseTabInfo[course.slug] = {
    hasTabs: tabs !== null && tabs.length > 0,
    tabIds: tabs ? tabs.map(t => t.id) : [],
  };
}

const totalLessons = allCourses.length;
const courseTabInfoJson = JSON.stringify(courseTabInfo);
---

<header class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      <!-- Logo å’Œæ ‡é¢˜ -->
      <div class="flex items-center space-x-4">
        <a href={base} class="flex items-center space-x-2 hover:opacity-80 transition-opacity">
          <span class="text-3xl">ğŸ¦€</span>
          <span class="text-xl font-bold text-gray-900">Rust äº’åŠ¨æ•™ç¨‹</span>
        </a>
      </div>

      <!-- å¯¼èˆªé“¾æ¥ -->
      <nav class="hidden md:flex items-center space-x-6">
        <a
          href={base}
          class="text-gray-700 hover:text-primary transition-colors font-medium"
        >
          é¦–é¡µ
        </a>
        <a
          id="start-learning-link"
          href={firstLessonUrl}
          class="text-gray-700 hover:text-primary transition-colors font-medium"
        >
          å¼€å§‹å­¦ä¹ 
        </a>
        <a
          href={`${base}/dashboard`}
          class="text-gray-700 hover:text-primary transition-colors font-medium"
        >
          å­¦ä¹ è¿›åº¦
        </a>

        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ï¼ˆå¾®è½¯é£æ ¼ï¼‰ -->
        <div class="flex items-center space-x-2 px-3 py-1.5 bg-blue-50 rounded-full" id="header-progress">
          <svg class="w-4 h-4 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-sm font-medium text-primary" id="header-progress-text">0%</span>
        </div>
      </nav>

      <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
      <button
        id="mobile-menu-button"
        class="md:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
        aria-label="æ‰“å¼€èœå•"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- ç§»åŠ¨ç«¯èœå• -->
  <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200">
    <nav class="container mx-auto px-4 py-4 space-y-2">
      <a
        href={base}
        class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
      >
        é¦–é¡µ
      </a>
      <a
        id="start-learning-link-mobile"
        href={firstLessonUrl}
        class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
      >
        å¼€å§‹å­¦ä¹ 
      </a>
      <a
        href={`${base}/dashboard`}
        class="block px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors"
      >
        å­¦ä¹ è¿›åº¦
      </a>
    </nav>
  </div>
</header>

<script define:vars={{ totalLessons, courseTabInfoJson }}>
  // è§£ætabä¿¡æ¯
  const courseTabInfo = JSON.parse(courseTabInfoJson);

  // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
  const menuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  menuButton?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  /**
   * è®¡ç®—åŸºäºtabçš„å®Œæˆè¿›åº¦
   */
  function calculateTabBasedProgress() {
    const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');

    let totalTabs = 0;
    let completedTabsCount = 0;

    // éå†æ‰€æœ‰è¯¾ç¨‹
    for (const [slug, info] of Object.entries(courseTabInfo)) {
      if (info.hasTabs) {
        // æœ‰tabçš„è¯¾ç¨‹ï¼šæŒ‰tabè®¡ç®—
        const tabProgressKey = `tab-progress-${slug}`;
        const tabProgress = localStorage.getItem(tabProgressKey);
        const tabsCompleted = tabProgress ? (JSON.parse(tabProgress).completedTabs || []) : [];

        totalTabs += info.tabIds.length;
        completedTabsCount += tabsCompleted.length;
      } else {
        // æ— tabçš„è¯¾ç¨‹ï¼šæŒ‰lessonè®¡ç®—ï¼ˆ1ä¸ªlesson = 1ä¸ªtabï¼‰
        totalTabs += 1;
        if (completedLessons.includes(slug)) {
          completedTabsCount += 1;
        }
      }
    }

    return { totalTabs, completedTabsCount };
  }

  // æ›´æ–° header è¿›åº¦æŒ‡ç¤ºå™¨
  function updateHeaderProgress() {
    try {
      const { totalTabs, completedTabsCount } = calculateTabBasedProgress();

      const percentage = totalTabs > 0 ? Math.round((completedTabsCount / totalTabs) * 100) : 0;

      const progressText = document.getElementById('header-progress-text');
      const progressContainer = document.getElementById('header-progress');

      if (progressText) {
        progressText.textContent = `${percentage}%`;
      }

      // æ ¹æ®è¿›åº¦æ”¹å˜é¢œè‰²
      if (progressContainer) {
        if (percentage === 100) {
          progressContainer.className = 'flex items-center space-x-2 px-3 py-1.5 bg-green-50 rounded-full';
          const icon = progressContainer.querySelector('svg');
          if (icon) icon.className = 'w-4 h-4 text-green-600';
          if (progressText) progressText.className = 'text-sm font-medium text-green-600';
        } else if (percentage >= 50) {
          progressContainer.className = 'flex items-center space-x-2 px-3 py-1.5 bg-yellow-50 rounded-full';
          const icon = progressContainer.querySelector('svg');
          if (icon) icon.className = 'w-4 h-4 text-yellow-600';
          if (progressText) progressText.className = 'text-sm font-medium text-yellow-600';
        }
      }
    } catch (error) {
      console.error('Failed to update header progress:', error);
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ›´æ–°è¿›åº¦
  updateHeaderProgress();

  // æ›´æ–°"å¼€å§‹å­¦ä¹ "é“¾æ¥åˆ°ä¸Šæ¬¡å­¦ä¹ çš„ä½ç½®
  function updateStartLearningLink() {
    const lastVisitedLesson = localStorage.getItem('lastVisitedLesson');
    if (lastVisitedLesson) {
      const link = document.getElementById('start-learning-link');
      const linkMobile = document.getElementById('start-learning-link-mobile');
      if (link) {
        link.setAttribute('href', lastVisitedLesson);
      }
      if (linkMobile) {
        linkMobile.setAttribute('href', lastVisitedLesson);
      }
    }
  }

  // é¡µé¢åŠ è½½æ—¶æ›´æ–°é“¾æ¥
  updateStartLearningLink();

  // ç›‘å¬ storage å˜åŒ–ï¼ˆè·¨æ ‡ç­¾é¡µåŒæ­¥ï¼‰
  window.addEventListener('storage', (e) => {
    if (e.key === 'completedLessons' || e.key?.startsWith('tab-progress-')) {
      updateHeaderProgress();
    }
    if (e.key === 'lastVisitedLesson') {
      updateStartLearningLink();
    }
  });

  // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼ˆåŒä¸€é¡µé¢å†…çš„æ›´æ–°ï¼‰
  window.addEventListener('progress-updated', () => {
    updateHeaderProgress();
  });
</script>
