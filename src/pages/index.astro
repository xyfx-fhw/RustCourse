---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import { groupByChapter, parseChapterName } from '@/lib/utils/courseLoader';
import type { CourseMetadata } from '@/types/course';

const base = import.meta.env.BASE_URL;

// è·å–æ‰€æœ‰è¯¾ç¨‹
const allCourses = await getCollection('courses');
const allCoursesMetadata: CourseMetadata[] = allCourses.map((c) => {
  const slugParts = c.slug.split('/');
  const ch = slugParts[0];
  const ls = slugParts[1];
  const ss = slugParts.length === 3 ? slugParts[2] : undefined;

  const chInfo = parseChapterName(ch);

  return {
    ...c.data,
    slug: c.slug,
    chapter: ch,
    chapterTitle: chInfo.title,
    lesson: ls,
    subsection: ss,
    url: `${base}/courses/${c.slug}`,
  };
});

const chapters = groupByChapter(allCoursesMetadata);

// è®¡ç®—æ€»è¯¾ç¨‹æ•°ï¼ˆæ‰å¹³åŒ–æ‰€æœ‰è¯¾ç¨‹å’Œå°èŠ‚ï¼‰
let totalLessons = 0;
for (const chapter of chapters) {
  for (const lesson of chapter.lessons) {
    if (lesson.subsections.length > 0) {
      totalLessons += lesson.subsections.length;
    } else if (lesson.metadata) {
      totalLessons += 1;
    }
  }
}

// è·å–ç¬¬ä¸€ä¸ªè¯¾ç¨‹/å°èŠ‚çš„URL
let firstLessonUrl = `${base}/courses/01-rust-basics/01-installation`;
if (chapters.length > 0 && chapters[0].lessons.length > 0) {
  const firstLesson = chapters[0].lessons[0];

  // ä¼˜å…ˆä½¿ç”¨è¯¾ç¨‹çš„æ¦‚è§ˆé¡µï¼ˆindex.mdï¼‰
  if (firstLesson.metadata) {
    firstLessonUrl = firstLesson.metadata.url;
  } else if (firstLesson.subsections.length > 0) {
    // å¦‚æœæ²¡æœ‰ index.mdï¼Œæ‰ä½¿ç”¨ç¬¬ä¸€ä¸ªå°èŠ‚
    firstLessonUrl = firstLesson.subsections[0].metadata.url;
  }
}
---

<BaseLayout>
  <Header />

  <main class="min-h-screen">
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-primary to-primary-dark text-white py-20">
      <div class="container mx-auto px-4 text-center">
        <h1 class="text-5xl md:text-6xl font-bold mb-6">
          ğŸ¦€ Rust äº’åŠ¨æ•™ç¨‹ï¼ˆæ­å»ºä¸­ï¼‰
        </h1>
        <p class="text-xl md:text-2xl mb-4 text-blue-100">
          ä»é›¶å¼€å§‹ï¼Œç³»ç»Ÿå­¦ä¹  Rust ç¼–ç¨‹è¯­è¨€
        </p>
        <p class="text-sm md:text-base mb-8 text-blue-200">
          ğŸ“– åŸºäº Rust å®˜æ–¹æ–‡æ¡£ç¼–å†™ï¼Œç»“åˆå®è·µç»éªŒå’Œæ•™å­¦æ–¹æ³•
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href={firstLessonUrl}
            class="btn btn-secondary text-lg px-8 py-3 inline-block"
          >
            å¼€å§‹å­¦ä¹  â†’
          </a>
          <a
            href="#courses"
            class="btn bg-white/10 hover:bg-white/20 text-white text-lg px-8 py-3 inline-block"
          >
            æŸ¥çœ‹è¯¾ç¨‹
          </a>
        </div>
        <!-- ä½œè€…ä¿¡æ¯ -->
        <div class="mt-8 text-blue-100">
          <p class="text-sm">ä½œè€…ï¼šé›ªäº‘é£æ˜Ÿ</p>
        </div>
      </div>
    </section>

    <!-- ç‰¹æ€§ä»‹ç» -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <div class="grid md:grid-cols-3 gap-8">
          <div class="text-center">
            <div class="text-4xl mb-4">ğŸ“š</div>
            <h3 class="text-xl font-bold mb-2">ç³»ç»ŸåŒ–å­¦ä¹ </h3>
            <p class="text-gray-600">ä»åŸºç¡€åˆ°è¿›é˜¶ï¼Œå¾ªåºæ¸è¿›çš„è¯¾ç¨‹ä½“ç³»</p>
          </div>
          <div class="text-center">
            <div class="text-4xl mb-4">ğŸ’¡</div>
            <h3 class="text-xl font-bold mb-2">å®è·µå¯¼å‘</h3>
            <p class="text-gray-600">æ¯èŠ‚è¯¾éƒ½æœ‰å®è·µç»ƒä¹ ï¼Œè¾¹å­¦è¾¹ç»ƒ</p>
          </div>
          <div class="text-center">
            <div class="text-4xl mb-4">âœ…</div>
            <h3 class="text-xl font-bold mb-2">è¿›åº¦è·Ÿè¸ª</h3>
            <p class="text-gray-600">è‡ªåŠ¨è®°å½•å­¦ä¹ è¿›åº¦ï¼Œéšæ—¶æŸ¥çœ‹</p>
          </div>
        </div>
      </div>
    </section>

    <!-- é‡è¦èµ„æºé“¾æ¥ -->
    <section class="py-12 bg-gradient-to-r from-gray-50 to-blue-50 border-y border-gray-200">
      <div class="container mx-auto px-4">
        <h2 class="text-2xl font-bold text-center mb-8 text-gray-900">
          ğŸ“š é‡è¦å­¦ä¹ èµ„æº
        </h2>
        <div class="max-w-5xl mx-auto grid md:grid-cols-2 lg:grid-cols-4 gap-5">
          <!-- Rust å®˜æ–¹æ–‡æ¡£ -->
          <a
            href="https://doc.rust-lang.org/book/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ“–</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  Rust å®˜æ–¹æ–‡æ¡£
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  The Rust Programming Language Book
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- Rust by Example -->
          <a
            href="https://doc.rust-lang.org/rust-by-example/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ’»</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  Rust by Example
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  é€šè¿‡å®ä¾‹å­¦ä¹  Rust
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- Rustonomicon -->
          <a
            href="https://doc.rust-lang.org/nomicon/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ”¥</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  Rustonomicon
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  Unsafe Rust é«˜çº§æŒ‡å—
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- åµŒå…¥å¼ Rust -->
          <a
            href="https://docs.rust-embedded.org/book/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ”Œ</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  åµŒå…¥å¼ Rust
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  Embedded Rust Book
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- Async Book -->
          <a
            href="https://rust-lang.github.io/async-book/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">âš¡</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  Async Rust
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  å¼‚æ­¥ç¼–ç¨‹å®ç”¨æŒ‡å—
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- Cargo Book -->
          <a
            href="https://doc.rust-lang.org/cargo/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ“¦</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  Cargo Book
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  Rust åŒ…ç®¡ç†å™¨æ–‡æ¡£
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- Rust Edition Guide -->
          <a
            href="https://doc.rust-lang.org/edition-guide/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ†•</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  Rust Edition Guide
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  ç‰ˆæœ¬ç‰¹æ€§ä¸è¿ç§»æŒ‡å—
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>

          <!-- Standard Library Docs -->
          <a
            href="https://doc.rust-lang.org/std/"
            target="_blank"
            rel="noopener noreferrer"
            class="group bg-white rounded-lg p-5 shadow-sm hover:shadow-lg transition-all hover:scale-105 border border-gray-200"
          >
            <div class="flex items-start gap-3">
              <span class="text-3xl flex-shrink-0">ğŸ“š</span>
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-gray-900 group-hover:text-primary mb-1.5 text-base leading-tight">
                  æ ‡å‡†åº“æ–‡æ¡£
                </h3>
                <p class="text-sm text-gray-600 leading-snug">
                  Rust æ ‡å‡†åº“ API å‚è€ƒ
                </p>
              </div>
              <svg class="w-4 h-4 text-gray-400 group-hover:text-primary flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </a>
        </div>
      </div>
    </section>

    <!-- è¯¾ç¨‹åˆ—è¡¨ -->
    <section id="courses" class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-12">è¯¾ç¨‹å†…å®¹</h2>

        <div class="max-w-4xl mx-auto space-y-8">
          {chapters.map((chapter, index) => (
            <div class="card">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-2xl font-bold text-gray-900 mb-2">
                    ç¬¬ {index + 1} ç« ï¼š{chapter.title}
                  </h3>
                  <p class="text-gray-600">
                    å…± {chapter.lessons.reduce((sum, lesson) => {
                      return sum + (lesson.subsections.length > 0 ? lesson.subsections.length : 1);
                    }, 0)} èŠ‚è¯¾
                  </p>
                </div>
                <span class="text-3xl">ğŸ“–</span>
              </div>

              <ul class="space-y-2">
                {chapter.lessons.map((lesson, lessonIndex) => {
                  // åˆ¤æ–­æ˜¯å¦æœ‰å°èŠ‚
                  if (lesson.subsections.length > 0) {
                    // æœ‰å°èŠ‚ï¼šæ˜¾ç¤ºè¯¾ç¨‹æ ‡é¢˜ï¼ˆå¦‚æœæœ‰ index.mdï¼‰å’Œå°èŠ‚åˆ—è¡¨
                    return (
                      <li class="border-l-2 border-gray-200 pl-4 space-y-2">
                        {lesson.metadata ? (
                          <a href={lesson.metadata.url} class="flex items-center font-medium text-gray-700 hover:text-primary mb-2">
                            <span>{index + 1}.{lessonIndex + 1} {lesson.metadata.title}</span>
                          </a>
                        ) : (
                          <div class="flex items-center font-medium text-gray-700 mb-2">
                            <span>{index + 1}.{lessonIndex + 1} {lesson.title}</span>
                          </div>
                        )}
                        <ul class="space-y-1 ml-4">
                          {lesson.subsections.map((subsection, subsectionIndex) => (
                            <li>
                              <a
                                href={subsection.metadata.url}
                                class="block p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                              >
                                <div class="flex items-center justify-between">
                                  <div class="flex items-center space-x-3">
                                    <span class="text-gray-400 font-medium">
                                      {index + 1}.{lessonIndex + 1}.{subsectionIndex + 1}
                                    </span>
                                    <span class="text-gray-900 group-hover:text-primary font-medium">
                                      {subsection.metadata.title}
                                    </span>
                                  </div>
                                  {subsection.metadata.duration && (
                                    <span class="text-sm text-gray-500">
                                      {subsection.metadata.duration} åˆ†é’Ÿ
                                    </span>
                                  )}
                                </div>
                                {subsection.metadata.description && (
                                  <p class="text-sm text-gray-600 mt-1 ml-12">
                                    {subsection.metadata.description}
                                  </p>
                                )}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </li>
                    );
                  } else {
                    // æ²¡æœ‰å°èŠ‚ï¼šç›´æ¥æ˜¾ç¤ºè¯¾ç¨‹é“¾æ¥
                    return (
                      <li>
                        <a
                          href={lesson.metadata?.url}
                          class="block p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                        >
                          <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                              <span class="text-gray-400 font-medium">
                                {index + 1}.{lessonIndex + 1}
                              </span>
                              <span class="text-gray-900 group-hover:text-primary font-medium">
                                {lesson.metadata?.title || lesson.title}
                              </span>
                            </div>
                            {lesson.metadata?.duration && (
                              <span class="text-sm text-gray-500">
                                {lesson.metadata.duration} åˆ†é’Ÿ
                              </span>
                            )}
                          </div>
                          {lesson.metadata?.description && (
                            <p class="text-sm text-gray-600 mt-1 ml-12">
                              {lesson.metadata.description}
                            </p>
                          )}
                        </a>
                      </li>
                    );
                  }
                })}
              </ul>
            </div>
          ))}
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="mt-12 text-center">
          <p class="text-gray-600">
            å…± <span class="font-bold text-primary">{chapters.length}</span> ç« 
            <span class="mx-2">|</span>
            <span class="font-bold text-primary">{totalLessons}</span> èŠ‚è¯¾ç¨‹
          </p>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-16 bg-primary text-white">
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl font-bold mb-4">å‡†å¤‡å¥½å¼€å§‹å­¦ä¹ äº†å—ï¼Ÿ</h2>
        <p class="text-xl text-blue-100 mb-8">
          ç°åœ¨å°±å¼€å§‹ä½ çš„ Rust å­¦ä¹ ä¹‹æ—…
        </p>
        <a
          href={firstLessonUrl}
          class="btn btn-secondary text-lg px-8 py-3 inline-block"
        >
          å¼€å§‹ç¬¬ä¸€è¯¾ â†’
        </a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-400 py-8">
    <div class="container mx-auto px-4 text-center">
      <p>Â© 2024 Rust äº’åŠ¨æ•™ç¨‹ | ä½œè€…ï¼šé›ªäº‘é£æ˜Ÿ | ä½¿ç”¨ Astro æ„å»º</p>
    </div>
  </footer>
</BaseLayout>
