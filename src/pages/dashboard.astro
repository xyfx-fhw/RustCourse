---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import { groupByChapter, parseChapterName } from '@/lib/utils/courseLoader';
import { parseTabContent } from '@/lib/utils/tabParser';
import type { CourseMetadata } from '@/types/course';

const base = import.meta.env.BASE_URL;

// è·å–æ‰€æœ‰è¯¾ç¨‹
const allCourses = await getCollection('courses');

// æ„å»ºè¯¾ç¨‹å…ƒæ•°æ®ï¼Œæ”¯æŒ 3 çº§ç»“æ„
const allCoursesMetadata: CourseMetadata[] = allCourses.map((c) => {
  const slugParts = c.slug.split('/');
  const ch = slugParts[0];
  const ls = slugParts[1];
  const ss = slugParts.length === 3 ? slugParts[2] : undefined;

  const chInfo = parseChapterName(ch);

  return {
    ...c.data,
    slug: c.slug,
    chapter: ch,
    chapterTitle: chInfo.title,
    lesson: ls,
    subsection: ss,
    url: `${base}/courses/${c.slug}`,
  };
});

// è®¡ç®—tabä¿¡æ¯ï¼šå“ªäº›è¯¾ç¨‹æœ‰tabï¼Œæ¯ä¸ªtabçš„ID
const courseTabInfo: Record<string, { hasTabs: boolean; tabIds: string[] }> = {};
for (const course of allCourses) {
  const tabs = parseTabContent(course.body);
  courseTabInfo[course.slug] = {
    hasTabs: tabs !== null && tabs.length > 0,
    tabIds: tabs ? tabs.map(t => t.id) : [],
  };
}

const chapters = groupByChapter(allCoursesMetadata);

// è®¡ç®—æ€»è¯¾ç¨‹æ•°ï¼ˆæ‰å¹³åŒ–æ‰€æœ‰è¯¾ç¨‹å’Œå°èŠ‚ï¼‰
let totalLessons = 0;
for (const chapter of chapters) {
  for (const lesson of chapter.lessons) {
    if (lesson.subsections.length > 0) {
      totalLessons += lesson.subsections.length;
    } else if (lesson.metadata) {
      totalLessons += 1;
    }
  }
}

// å°†courseTabInfoä¼ é€’ç»™å‰ç«¯
const courseTabInfoJson = JSON.stringify(courseTabInfo);
---

<BaseLayout title="å­¦ä¹ è¿›åº¦" description="æŸ¥çœ‹ä½ çš„ Rust å­¦ä¹ è¿›åº¦">
  <Header />

  <main class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-12">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          ğŸ“Š å­¦ä¹ è¿›åº¦
        </h1>
        <p class="text-xl text-gray-600">
          è¿½è¸ªä½ çš„ Rust å­¦ä¹ æ—…ç¨‹
        </p>
      </div>

      <!-- æ€»ä½“è¿›åº¦å¡ç‰‡ -->
      <div class="max-w-4xl mx-auto mb-12">
        <div class="card bg-gradient-to-br from-primary to-primary-dark text-white">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold mb-2">æ€»ä½“è¿›åº¦</h2>
              <p class="text-blue-100">å®Œæˆè¯¾ç¨‹å³å¯è·å¾—è¯ä¹¦</p>
            </div>
            <div class="text-5xl">ğŸ¦€</div>
          </div>

          <!-- è¿›åº¦æ¡ -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">å·²å®Œæˆè¯¾ç¨‹</span>
              <span class="text-sm font-medium" id="progress-text">0 / {totalLessons}</span>
            </div>
            <div class="w-full bg-white/20 rounded-full h-3">
              <div
                id="progress-bar"
                class="bg-secondary h-3 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span id="progress-percentage">0%</span>
            <span>å®Œæˆ 90% å³å¯è·å¾—è¯ä¹¦</span>
          </div>
        </div>
      </div>

      <!-- ç« èŠ‚è¿›åº¦ -->
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">å„ç« èŠ‚è¿›åº¦</h2>

        <div class="space-y-6">
          {chapters.map((chapter, index) => (
            <div class="card">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-xl font-bold text-gray-900 mb-2">
                    ç¬¬ {index + 1} ç« ï¼š{chapter.title}
                  </h3>
                  <p class="text-gray-600">
                    å…± {chapter.lessons.reduce((sum, lesson) => {
                      return sum + (lesson.subsections.length > 0 ? lesson.subsections.length : 1);
                    }, 0)} èŠ‚è¯¾
                  </p>
                </div>
                <span class="text-3xl">ğŸ“–</span>
              </div>

              <!-- ç« èŠ‚è¿›åº¦æ¡ -->
              <div class="mb-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div
                    class="chapter-progress bg-primary h-2 rounded-full transition-all duration-500"
                    data-chapter={chapter.id}
                    style="width: 0%"
                  ></div>
                </div>
              </div>

              <!-- è¯¾ç¨‹åˆ—è¡¨ -->
              <ul class="space-y-2">
                {chapter.lessons.map((lesson, lessonIndex) => {
                  // åˆ¤æ–­æ˜¯å¦æœ‰å°èŠ‚
                  if (lesson.subsections.length > 0) {
                    // æœ‰å°èŠ‚ï¼šæ¸²æŸ“è¯¾ç¨‹å’Œå°èŠ‚åˆ—è¡¨
                    return (
                      <>
                        {/* æ¸²æŸ“ index.mdï¼ˆå¦‚æœå­˜åœ¨ï¼‰ */}
                        {lesson.metadata && (
                          <li>
                            <div class="flex items-center gap-2">
                              <a
                                href={lesson.metadata.url}
                                class="flex-1 block p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                                data-lesson-slug={lesson.metadata.slug}
                              >
                                <div class="flex items-center justify-between">
                                  <div class="flex items-center space-x-3">
                                    <span class="lesson-status-icon text-2xl">â¬œ</span>
                                    <div>
                                      <div class="text-gray-900 group-hover:text-primary font-medium">
                                        {index + 1}.{lessonIndex + 1} {lesson.metadata.title}
                                      </div>
                                      {lesson.metadata.duration && (
                                        <div class="text-sm text-gray-500">
                                          â±ï¸ {lesson.metadata.duration} åˆ†é’Ÿ
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <svg class="w-5 h-5 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                  </svg>
                                </div>
                              </a>
                              <button
                                class="reset-lesson-btn hidden px-3 py-2 text-xs bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors whitespace-nowrap"
                                data-lesson-slug={lesson.metadata.slug}
                                title="æ¸…é™¤è¯¥è¯¾ç¨‹çš„å­¦ä¹ è¿›åº¦"
                              >
                                é‡æ–°å­¦ä¹ 
                              </button>
                            </div>
                          </li>
                        )}

                        {/* æ¸²æŸ“æ‰€æœ‰å°èŠ‚ */}
                        {lesson.subsections.map((subsection, subsectionIndex) => (
                          <li>
                            <div class="flex items-center gap-2">
                              <a
                                href={subsection.metadata.url}
                                class="flex-1 block p-3 rounded-lg hover:bg-gray-50 transition-colors group ml-4"
                                data-lesson-slug={subsection.metadata.slug}
                              >
                                <div class="flex items-center justify-between">
                                  <div class="flex items-center space-x-3">
                                    <span class="lesson-status-icon text-2xl">â¬œ</span>
                                    <div>
                                      <div class="text-gray-900 group-hover:text-primary font-medium">
                                        {index + 1}.{lessonIndex + 1}.{subsectionIndex + 1} {subsection.metadata.title}
                                      </div>
                                      {subsection.metadata.duration && (
                                        <div class="text-sm text-gray-500">
                                          â±ï¸ {subsection.metadata.duration} åˆ†é’Ÿ
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <svg class="w-5 h-5 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                  </svg>
                                </div>
                              </a>
                              <button
                                class="reset-lesson-btn hidden px-3 py-2 text-xs bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors whitespace-nowrap"
                                data-lesson-slug={subsection.metadata.slug}
                                title="æ¸…é™¤è¯¥è¯¾ç¨‹çš„å­¦ä¹ è¿›åº¦"
                              >
                                é‡æ–°å­¦ä¹ 
                              </button>
                            </div>
                          </li>
                        ))}
                      </>
                    );
                  } else {
                    // æ²¡æœ‰å°èŠ‚ï¼šç›´æ¥æ¸²æŸ“è¯¾ç¨‹é“¾æ¥
                    return (
                      <li>
                        <div class="flex items-center gap-2">
                          <a
                            href={lesson.metadata?.url}
                            class="flex-1 block p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                            data-lesson-slug={lesson.metadata?.slug}
                          >
                            <div class="flex items-center justify-between">
                              <div class="flex items-center space-x-3">
                                <span class="lesson-status-icon text-2xl">â¬œ</span>
                                <div>
                                  <div class="text-gray-900 group-hover:text-primary font-medium">
                                    {index + 1}.{lessonIndex + 1} {lesson.metadata?.title || lesson.title}
                                  </div>
                                  {lesson.metadata?.duration && (
                                    <div class="text-sm text-gray-500">
                                      â±ï¸ {lesson.metadata.duration} åˆ†é’Ÿ
                                    </div>
                                  )}
                                </div>
                              </div>
                              <svg class="w-5 h-5 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                              </svg>
                            </div>
                          </a>
                          <button
                            class="reset-lesson-btn hidden px-3 py-2 text-xs bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors whitespace-nowrap"
                            data-lesson-slug={lesson.metadata?.slug}
                            title="æ¸…é™¤è¯¥è¯¾ç¨‹çš„å­¦ä¹ è¿›åº¦"
                          >
                            é‡æ–°å­¦ä¹ 
                          </button>
                        </div>
                      </li>
                    );
                  }
                })}
              </ul>
            </div>
          ))}
        </div>
      </div>

      <!-- æç¤ºä¿¡æ¯ -->
      <div class="max-w-4xl mx-auto mt-12">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-bold text-blue-900 mb-2">ğŸ’¡ æç¤º</h3>
              <p class="text-blue-800">
                å­¦ä¹ è¿›åº¦è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®ä¼šå¯¼è‡´è¿›åº¦ä¸¢å¤±ã€‚
                å®Œæˆ 90% ä»¥ä¸Šçš„è¯¾ç¨‹å³å¯è·å¾—ç»“ä¸šè¯ä¹¦ï¼
              </p>
            </div>
            <button
              id="reset-progress-btn"
              class="ml-4 px-3 py-1 bg-gray-300 text-gray-700 text-xs rounded hover:bg-gray-400 transition-colors"
              title="é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦ï¼ˆéœ€è¦è¾“å…¥ç¡®è®¤ï¼‰"
            >
              æ‰€æœ‰è¿›åº¦é‡ç½®
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-400 py-8">
    <div class="container mx-auto px-4 text-center">
      <p>Â© 2024 Rust äº’åŠ¨æ•™ç¨‹ | ä½œè€…ï¼šé›ªäº‘é£æ˜Ÿ | ä½¿ç”¨ Astro æ„å»º</p>
    </div>
  </footer>
</BaseLayout>

<script define:vars={{ courseTabInfoJson }}>
  // è§£ætabä¿¡æ¯
  const courseTabInfo = JSON.parse(courseTabInfoJson);

  /**
   * è®¡ç®—åŸºäºtabçš„å®Œæˆè¿›åº¦
   * å¦‚æœè¯¾ç¨‹æœ‰tabï¼šå®Œæˆè¿›åº¦ = completedTabs / totalTabs
   * å¦‚æœè¯¾ç¨‹æ— tabï¼šå®Œæˆè¿›åº¦ = 0 æˆ– 1ï¼ˆæ ¹æ®completedLessonsï¼‰
   */
  function calculateTabBasedProgress() {
    const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');

    let totalTabs = 0;
    let completedTabsCount = 0;

    // éå†æ‰€æœ‰è¯¾ç¨‹
    for (const [slug, info] of Object.entries(courseTabInfo)) {
      if (info.hasTabs) {
        // æœ‰tabçš„è¯¾ç¨‹ï¼šæŒ‰tabè®¡ç®—
        const tabProgressKey = `tab-progress-${slug}`;
        const tabProgress = localStorage.getItem(tabProgressKey);
        const tabsCompleted = tabProgress ? (JSON.parse(tabProgress).completedTabs || []) : [];

        totalTabs += info.tabIds.length;
        completedTabsCount += tabsCompleted.length;
      } else {
        // æ— tabçš„è¯¾ç¨‹ï¼šæŒ‰lessonè®¡ç®—ï¼ˆ1ä¸ªlesson = 1ä¸ªtabï¼‰
        totalTabs += 1;
        if (completedLessons.includes(slug)) {
          completedTabsCount += 1;
        }
      }
    }

    return { totalTabs, completedTabsCount };
  }

  /**
   * æ›´æ–°è¿›åº¦æ˜¾ç¤º
   */
  function updateProgress() {
    const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');
    const { totalTabs, completedTabsCount } = calculateTabBasedProgress();

    // æ›´æ–°æ€»ä½“è¿›åº¦ï¼ˆåŸºäºtabï¼‰
    const percentage = totalTabs > 0 ? Math.round((completedTabsCount / totalTabs) * 100) : 0;

    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercentage = document.getElementById('progress-percentage');

    if (progressBar) progressBar.style.width = `${percentage}%`;
    if (progressText) progressText.textContent = `${completedTabsCount} / ${totalTabs}`;
    if (progressPercentage) progressPercentage.textContent = `${percentage}%`;

    // æ›´æ–°è¯¾ç¨‹çŠ¶æ€å›¾æ ‡å’ŒæŒ‰é’®æ˜¾ç¤º
    document.querySelectorAll('[data-lesson-slug]').forEach((element) => {
      const slug = element.getAttribute('data-lesson-slug');
      const statusIcon = element.querySelector('.lesson-status-icon');
      const resetBtn = element.parentElement ? element.parentElement.querySelector('.reset-lesson-btn') : null;

      if (statusIcon && slug) {
        const info = courseTabInfo[slug];
        let hasProgress = false;

        if (info && info.hasTabs) {
          // æœ‰tabçš„è¯¾ç¨‹ï¼šæ£€æŸ¥tabå®Œæˆåº¦
          const tabProgressKey = `tab-progress-${slug}`;
          const tabProgress = localStorage.getItem(tabProgressKey);
          const tabsCompleted = tabProgress ? (JSON.parse(tabProgress).completedTabs || []) : [];

          if (tabsCompleted.length === info.tabIds.length && info.tabIds.length > 0) {
            // æ‰€æœ‰tabéƒ½å®Œæˆäº†
            statusIcon.textContent = 'âœ…';
            hasProgress = true;
          } else if (tabsCompleted.length > 0) {
            // éƒ¨åˆ†tabå®Œæˆ
            statusIcon.textContent = 'ğŸ”µ';
            hasProgress = true;
          } else {
            statusIcon.textContent = 'â¬œ';
            hasProgress = false;
          }
        } else {
          // æ— tabçš„è¯¾ç¨‹ï¼šä½¿ç”¨åŸæ¥çš„é€»è¾‘
          if (completedLessons.includes(slug)) {
            statusIcon.textContent = 'âœ…';
            hasProgress = true;
          } else {
            statusIcon.textContent = 'â¬œ';
            hasProgress = false;
          }
        }

        // æ ¹æ®æ˜¯å¦æœ‰è¿›åº¦æ˜¾ç¤º/éšè—é‡æ–°å­¦ä¹ æŒ‰é’®
        if (resetBtn) {
          if (hasProgress) {
            resetBtn.classList.remove('hidden');
          } else {
            resetBtn.classList.add('hidden');
          }
        }
      }
    });

    // æ›´æ–°å„ç« èŠ‚è¿›åº¦ï¼ˆåŸºäºtabï¼‰
    const chapterProgress = new Map();
    document.querySelectorAll('[data-lesson-slug]').forEach((element) => {
      const slug = element.getAttribute('data-lesson-slug');
      if (!slug) return;

      const chapter = slug.split('/')[0];
      if (!chapterProgress.has(chapter)) {
        chapterProgress.set(chapter, { total: 0, completed: 0 });
      }

      const stats = chapterProgress.get(chapter);
      const info = courseTabInfo[slug];

      if (info && info.hasTabs) {
        // æœ‰tabçš„è¯¾ç¨‹ï¼šæŒ‰tabè®¡ç®—
        const tabProgressKey = `tab-progress-${slug}`;
        const tabProgress = localStorage.getItem(tabProgressKey);
        const tabsCompleted = tabProgress ? (JSON.parse(tabProgress).completedTabs || []) : [];

        stats.total += info.tabIds.length;
        stats.completed += tabsCompleted.length;
      } else {
        // æ— tabçš„è¯¾ç¨‹ï¼šæŒ‰lessonè®¡ç®—
        stats.total += 1;
        if (completedLessons.includes(slug)) {
          stats.completed += 1;
        }
      }
    });

    document.querySelectorAll('.chapter-progress').forEach((bar) => {
      const chapterId = bar.getAttribute('data-chapter');
      if (!chapterId) return;

      const stats = chapterProgress.get(chapterId);
      if (stats && stats.total > 0) {
        const chapterPercentage = Math.round((stats.completed / stats.total) * 100);
        bar.style.width = `${chapterPercentage}%`;
      }
    });
  }

  // é¡µé¢åŠ è½½æ—¶æ›´æ–°è¿›åº¦
  updateProgress();

  // é‡ç½®è¿›åº¦æŒ‰é’®
  const resetBtn = document.getElementById('reset-progress-btn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      const userInput = prompt('âš ï¸ æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰å­¦ä¹ è¿›åº¦ï¼\n\nè¯·è¾“å…¥"è¿›åº¦é‡ç½®"ï¼ˆä¸å«å¼•å·ï¼‰ä»¥ç¡®è®¤ï¼š');

      if (userInput === 'è¿›åº¦é‡ç½®') {
        // æ¸…é™¤lessonçº§åˆ«çš„è¿›åº¦
        localStorage.removeItem('completedLessons');

        // æ¸…é™¤æ‰€æœ‰tabçº§åˆ«çš„è¿›åº¦
        for (const slug in courseTabInfo) {
          if (courseTabInfo.hasOwnProperty(slug)) {
            const tabProgressKey = `tab-progress-${slug}`;
            localStorage.removeItem(tabProgressKey);
          }
        }

        // è§¦å‘ storage äº‹ä»¶é€šçŸ¥å…¶ä»–é¡µé¢
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'completedLessons',
          newValue: null,
          oldValue: null
        }));

        // åˆ·æ–°é¡µé¢æ˜¾ç¤º
        updateProgress();
        alert('âœ… å­¦ä¹ è¿›åº¦å·²é‡ç½®ï¼');
      } else if (userInput !== null) {
        // ç”¨æˆ·è¾“å…¥äº†å†…å®¹ä½†ä¸åŒ¹é…
        alert('âŒ è¾“å…¥ä¸æ­£ç¡®ï¼Œè¿›åº¦é‡ç½®å·²å–æ¶ˆ');
      }
      // å¦‚æœ userInput æ˜¯ nullï¼Œè¯´æ˜ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä»€ä¹ˆéƒ½ä¸åš
    });
  }

  // ç‚¹å‡»"é‡æ–°å­¦ä¹ "æŒ‰é’®æ¸…ç©ºè¯¾ç¨‹è¿›åº¦
  document.querySelectorAll('.reset-lesson-btn').forEach((button) => {
    button.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      const slug = button.getAttribute('data-lesson-slug');

      if (slug) {
        const info = courseTabInfo[slug];

        if (info && info.hasTabs) {
          // æœ‰tabçš„è¯¾ç¨‹ï¼šæ¸…ç©ºæ‰€æœ‰tabè¿›åº¦ï¼Œå¹¶é‡ç½®åˆ°ç¬¬ä¸€ä¸ªtab
          const tabProgressKey = `tab-progress-${slug}`;
          localStorage.setItem(tabProgressKey, JSON.stringify({
            currentTab: 0,
            completedTabs: [],
            lastUpdated: Date.now(),
          }));
        } else {
          // æ— tabçš„è¯¾ç¨‹ï¼šä»completedLessonsä¸­ç§»é™¤
          const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');
          const index = completedLessons.indexOf(slug);
          if (index > -1) {
            completedLessons.splice(index, 1);
            localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
          }
        }

        // è§¦å‘è¿›åº¦æ›´æ–°äº‹ä»¶
        window.dispatchEvent(new Event('progress-updated'));
        window.dispatchEvent(new StorageEvent('storage', {
          key: 'completedLessons',
          newValue: localStorage.getItem('completedLessons'),
          oldValue: null
        }));

        // æ›´æ–°æ˜¾ç¤º
        updateProgress();
      }
    });
  });
</script>
