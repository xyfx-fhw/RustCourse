---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Header from '@/components/layout/Header.astro';
import { groupByChapter, parseChapterName } from '@/lib/utils/courseLoader';
import type { CourseMetadata } from '@/types/course';

const base = import.meta.env.BASE_URL;

// è·å–æ‰€æœ‰è¯¾ç¨‹
const allCourses = await getCollection('courses');
const allCoursesMetadata: CourseMetadata[] = allCourses.map((c) => {
  const [ch, ls] = c.slug.split('/');
  const chInfo = parseChapterName(ch);
  return {
    ...c.data,
    slug: c.slug,
    chapter: ch,
    chapterTitle: chInfo.title,
    lesson: ls,
    url: `${base}/courses/${c.slug}`,
  };
});

const chapters = groupByChapter(allCoursesMetadata);
const totalLessons = allCoursesMetadata.length;
---

<BaseLayout title="å­¦ä¹ è¿›åº¦" description="æŸ¥çœ‹ä½ çš„ Rust å­¦ä¹ è¿›åº¦">
  <Header />

  <main class="min-h-screen bg-gray-50">
    <div class="container mx-auto px-4 py-12">
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
          ğŸ“Š å­¦ä¹ è¿›åº¦
        </h1>
        <p class="text-xl text-gray-600">
          è¿½è¸ªä½ çš„ Rust å­¦ä¹ æ—…ç¨‹
        </p>
      </div>

      <!-- æ€»ä½“è¿›åº¦å¡ç‰‡ -->
      <div class="max-w-4xl mx-auto mb-12">
        <div class="card bg-gradient-to-br from-primary to-primary-dark text-white">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold mb-2">æ€»ä½“è¿›åº¦</h2>
              <p class="text-blue-100">å®Œæˆè¯¾ç¨‹å³å¯è·å¾—è¯ä¹¦</p>
            </div>
            <div class="text-5xl">ğŸ¦€</div>
          </div>

          <!-- è¿›åº¦æ¡ -->
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium">å·²å®Œæˆè¯¾ç¨‹</span>
              <span class="text-sm font-medium" id="progress-text">0 / {totalLessons}</span>
            </div>
            <div class="w-full bg-white/20 rounded-full h-3">
              <div
                id="progress-bar"
                class="bg-secondary h-3 rounded-full transition-all duration-500"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="flex items-center justify-between text-sm">
            <span id="progress-percentage">0%</span>
            <span>å®Œæˆ 90% å³å¯è·å¾—è¯ä¹¦</span>
          </div>
        </div>
      </div>

      <!-- ç« èŠ‚è¿›åº¦ -->
      <div class="max-w-4xl mx-auto">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">å„ç« èŠ‚è¿›åº¦</h2>

        <div class="space-y-6">
          {chapters.map((chapter, index) => (
            <div class="card">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h3 class="text-xl font-bold text-gray-900 mb-2">
                    ç¬¬ {index + 1} ç« ï¼š{chapter.title}
                  </h3>
                  <p class="text-gray-600">å…± {chapter.lessons.length} èŠ‚è¯¾</p>
                </div>
                <span class="text-3xl">ğŸ“–</span>
              </div>

              <!-- ç« èŠ‚è¿›åº¦æ¡ -->
              <div class="mb-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div
                    class="chapter-progress bg-primary h-2 rounded-full transition-all duration-500"
                    data-chapter={chapter.id}
                    style="width: 0%"
                  ></div>
                </div>
              </div>

              <!-- è¯¾ç¨‹åˆ—è¡¨ -->
              <ul class="space-y-2">
                {chapter.lessons.map((lesson, lessonIndex) => (
                  <li>
                    <a
                      href={lesson.url}
                      class="block p-3 rounded-lg hover:bg-gray-50 transition-colors group"
                      data-lesson-slug={lesson.slug}
                    >
                      <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                          <span class="lesson-checkbox text-2xl">â¬œ</span>
                          <div>
                            <div class="text-gray-900 group-hover:text-primary font-medium">
                              {index + 1}.{lessonIndex + 1} {lesson.title}
                            </div>
                            {lesson.duration && (
                              <div class="text-sm text-gray-500">
                                â±ï¸ {lesson.duration} åˆ†é’Ÿ
                              </div>
                            )}
                          </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                      </div>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </div>

      <!-- æç¤ºä¿¡æ¯ -->
      <div class="max-w-4xl mx-auto mt-12">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-bold text-blue-900 mb-2">ğŸ’¡ æç¤º</h3>
              <p class="text-blue-800">
                å­¦ä¹ è¿›åº¦è‡ªåŠ¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®ä¼šå¯¼è‡´è¿›åº¦ä¸¢å¤±ã€‚
                å®Œæˆ 90% ä»¥ä¸Šçš„è¯¾ç¨‹å³å¯è·å¾—ç»“ä¸šè¯ä¹¦ï¼
              </p>
            </div>
            <button
              id="reset-progress-btn"
              class="ml-4 px-3 py-1 bg-gray-300 text-gray-700 text-xs rounded hover:bg-gray-400 transition-colors"
              title="é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦ï¼ˆéœ€è¦è¾“å…¥ç¡®è®¤ï¼‰"
            >
              é‡ç½®è¿›åº¦
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-400 py-8">
    <div class="container mx-auto px-4 text-center">
      <p>Â© 2024 Rust å­¦ä¹ è¯¾ç¨‹ | ä½¿ç”¨ Astro æ„å»º</p>
    </div>
  </footer>
</BaseLayout>

<script>
  // ç®€å•çš„è¿›åº¦è·Ÿè¸ªï¼ˆä½¿ç”¨ localStorageï¼‰
  function updateProgress() {
    const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');
    const totalLessons = document.querySelectorAll('[data-lesson-slug]').length;

    // æ›´æ–°æ€»ä½“è¿›åº¦
    const completedCount = completedLessons.length;
    const percentage = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;

    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercentage = document.getElementById('progress-percentage');

    if (progressBar) progressBar.style.width = `${percentage}%`;
    if (progressText) progressText.textContent = `${completedCount} / ${totalLessons}`;
    if (progressPercentage) progressPercentage.textContent = `${percentage}%`;

    // æ›´æ–°è¯¾ç¨‹å¤é€‰æ¡†
    document.querySelectorAll('[data-lesson-slug]').forEach((element) => {
      const slug = element.getAttribute('data-lesson-slug');
      const checkbox = element.querySelector('.lesson-checkbox');
      if (checkbox && completedLessons.includes(slug)) {
        checkbox.textContent = 'âœ…';
      }
    });

    // æ›´æ–°å„ç« èŠ‚è¿›åº¦
    const chapterProgress = new Map();
    document.querySelectorAll('[data-lesson-slug]').forEach((element) => {
      const slug = element.getAttribute('data-lesson-slug');
      if (!slug) return;

      const chapter = slug.split('/')[0];
      if (!chapterProgress.has(chapter)) {
        chapterProgress.set(chapter, { total: 0, completed: 0 });
      }

      const stats = chapterProgress.get(chapter);
      stats.total++;
      if (completedLessons.includes(slug)) {
        stats.completed++;
      }
    });

    document.querySelectorAll('.chapter-progress').forEach((bar) => {
      const chapterId = bar.getAttribute('data-chapter');
      if (!chapterId) return;

      const stats = chapterProgress.get(chapterId);
      if (stats && stats.total > 0) {
        const chapterPercentage = Math.round((stats.completed / stats.total) * 100);
        (bar as HTMLElement).style.width = `${chapterPercentage}%`;
      }
    });
  }

  // é¡µé¢åŠ è½½æ—¶æ›´æ–°è¿›åº¦
  updateProgress();

  // é‡ç½®è¿›åº¦æŒ‰é’®
  const resetBtn = document.getElementById('reset-progress-btn');
  resetBtn?.addEventListener('click', () => {
    const userInput = prompt('âš ï¸ æ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰å­¦ä¹ è¿›åº¦ï¼\n\nè¯·è¾“å…¥"è¿›åº¦é‡ç½®"ï¼ˆä¸å«å¼•å·ï¼‰ä»¥ç¡®è®¤ï¼š');

    if (userInput === 'è¿›åº¦é‡ç½®') {
      localStorage.removeItem('completedLessons');

      // è§¦å‘ storage äº‹ä»¶é€šçŸ¥å…¶ä»–é¡µé¢
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'completedLessons',
        newValue: null,
        oldValue: localStorage.getItem('completedLessons')
      }));

      // åˆ·æ–°é¡µé¢æ˜¾ç¤º
      updateProgress();
      alert('âœ… å­¦ä¹ è¿›åº¦å·²é‡ç½®ï¼');
    } else if (userInput !== null) {
      // ç”¨æˆ·è¾“å…¥äº†å†…å®¹ä½†ä¸åŒ¹é…
      alert('âŒ è¾“å…¥ä¸æ­£ç¡®ï¼Œè¿›åº¦é‡ç½®å·²å–æ¶ˆ');
    }
    // å¦‚æœ userInput æ˜¯ nullï¼Œè¯´æ˜ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä»€ä¹ˆéƒ½ä¸åš
  });

  // ç‚¹å‡»è¯¾ç¨‹æ—¶æ ‡è®°ä¸ºå®Œæˆï¼ˆç®€å•å®ç°ï¼‰
  document.querySelectorAll('[data-lesson-slug]').forEach((element) => {
    element.addEventListener('click', (e) => {
      const slug = element.getAttribute('data-lesson-slug');
      if (slug) {
        const completedLessons = JSON.parse(localStorage.getItem('completedLessons') || '[]');
        if (!completedLessons.includes(slug)) {
          completedLessons.push(slug);
          localStorage.setItem('completedLessons', JSON.stringify(completedLessons));
        }
      }
    });
  });
</script>
